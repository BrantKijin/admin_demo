<!DOCTYPE html>
<html lagn="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns="http://www.w3.org/1999/html" layout:decorate="~{layout/default-layout}">

<head>
<title>공지사항&게시판</title>

<body layout:fragment="content">

<div id="warpper">
	
    <div class="sub-box bg04">
        <div class="sub-box mask">
            <div class="sub-box_tit">
                <h3>
                    커뮤니티
                </h3>
                <span>서비스 A/S문의 및 현장 방송장비 상태를 문의하세요.</span>
            </div>
        </div>
    </div>
	<div class="cont">
        <section class="board_sec">
            <div class="board-tit">
                <h4>게시판</h4>
                <div class="button__box mgLAuto">
                    <div class="board-search">
                        <div class="selectbox">
                            <select id="searchOpt" name="searchOpt">
                                <option value="title">제목</option>
                                <option value="writer">작성자</option>
                            </select>
                        </div>
                        <input type="search" class="board-search__input" title="검색입력" id="searchInput"  placeholder="검색어를 입력하세요.">
                        <button class="board-search__btn" type="button" title="검색" id = btn-search>검색</button>
                    </div>
                </div>
            </div>
            <div class="board-table mb20 w100">
                <table class="board-table_list">
                    <colgroup>
                        <col width="80">
                        <col width="88">
                        <col width="*">
                        <col width="88">
                        <col width="120">
                        <col width="88">
                    </colgroup>
                    <tbody>
                        <tr>
                            <td class="t_head">
                                번호
                            </td>
                            <td class="t_head">
                                상태
                            </td>
                            <td class="t_head">
                                제목
                            </td>
                            <td class="t_head">
                                작성자
                            </td>
                            <td class="t_head">
                                등록일
                            </td>
                            <td class="t_head">
                                조회수
                            </td>
                        </tr>
                        <tr th:class="${dto.titleType != null } ? 'bold-row' : ''"
                        th:each="dto : ${result.dtoList}"  th:onclick="password_confirm([[${dto.id}]],[[${dto.titleType}]])"style="cursor: pointer" title="상세페이지">
                            <td><span th:if="${dto.titleType == null}" th:text="${dto.id}"></span></td>
                            <td>
                                <span th:if="${dto.titleType == null and dto.hasComment == false}">문의</span>
                                <span th:if="${dto.titleType == null and dto.hasComment}">답변완료</span>
                                <span th:if="${dto.titleType != null}" th:text="${dto.titleType}">
                            </span></td>
                            <td class="t_left">
                                <a>
                                    <span class="link">[[${dto.title}]]</span>
                                    <span class="secret_ico" th:if="${dto.titleType == null}">자물쇠</span>
                                    <span class="new_ico"><input type='hidden' th:id="'new_ico_'+${dto.id}" th:value="${dto.createdAt}" /></span>
                                </a>
                            </td>
                            <td>[[${dto.writer}]]</td>
                            <td>[[${dto.createdAt}]]</td>
                            <td>[[${dto.viewCount}]]</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        <div class="page-box">
            <div class="page-box_list">
                <div class="prev_btn" th:if="${result.prev}">
                    <a th:href="@{/board/index(page= ${result.start -1},
                                        type=${pageRequestDTO.type} ,
                                        keyword = ${pageRequestDTO.keyword},
                                        title=${param.title},
                                        writer=${param.writer} ) }" tabindex="-1">
                        <span class="caption">이전</span>
                    </a>
                </div>
        
                <div class="page_num">
                    <div th:each="page: ${result.pageList}">
                        <a th:class=" 'page-item ' + ${result.page == page?'active':''} " th:href="@{/board/index(page = ${page} ,
                                    type=${pageRequestDTO.type} ,
                                    keyword = ${pageRequestDTO.keyword},
                                    title=${param.title},
                                    writer=${param.writer}  )}">[[${page}]]</a>
                    </div>
                </div>
                <div class="next_btn" th:if="${result.next}">
                    <a th:href="@{/board/index(page= ${result.end + 1},
                                        type=${pageRequestDTO.type} ,
                                        keyword = ${pageRequestDTO.keyword},
                                        title=${param.title},
                                        writer=${param.writer} ) }"><span class="caption">다음</span></a>
                </div>
            </div>
            <button class="button button__Big button__Navy writeBtn" id="btn-write-manager"  sec:authorize="hasAuthority('ADMIN')">공지사항 등록</button>
            <button class="button button__Big button__Navy writeBtn" id="btn-write" sec:authorize="!hasAuthority('ADMIN')">글쓰기</button>
        </div>
        </section>
        
    </div>
    <input type="hidden" id="searchVal" name="searchVal" />
    <div class="layer-bg" id="pw_layer" style="display: none;">
        <div class="layer-cont w280p">
            <button type="button" class="close_btn" style="cursor: pointer">
                닫기
            </button>
            <div class="layer-tit">
                <h4>비밀번호 입력</h4>
            </div>
                <div class="layer-insert">
                    <input type="hidden" id="id">
                    <input type="password" id="password" placeholder="등록한 비밀번호를 입력해주세요.">
                </div>
            <div class="button__box">
                <button class="button button__Basic button__Navy w50" id="btn-confirm">확인</button>
                <button class="button button__Basic button__White w50" id="btn-cancel">취소</button>
            </div>
        </div>
    </div>
</div>
<script>

    $(document).ready(function () {
        $(".board-tab").addClass("active");
        $(".comunity-tab").addClass("active");
        $(".sub_menu").addClass("on");
        $("#board_sub").css('display', 'flex');
        $('.new_ico').each(function () {
            var input = $(this).find('input');
            var dateString = input.val();
            var date = new Date(dateString);
            var currentDateMinus14 = new Date();
            currentDateMinus14.setDate(currentDateMinus14.getDate() - 14);
            if (date < currentDateMinus14) {
                $(this).css('display', 'none');
            }
        });
        $(".close_btn").click(function () {
            $(".layer-bg").hide();
        });

        $("#btn-cancel").click(function () {
            $(".layer-bg").hide();
        });

        $("#btn-write-manager").click(function () {
            window.location.href = "/board/write-manager";
        });
        $("#btn-write").click(function () {
            window.location.href = "/board/write-user";
        });
        var selectedSearchOpt = ""; 
        selectedSearchOpt = $("#searchOpt").val();
        $("#searchOpt").val(selectedSearchOpt);

        // 검색 옵션 변경 시 변수에 선택한 값을 저장합니다.
        $("#searchOpt").change(function () {
            selectedSearchOpt = $(this).val();
        });

        $("#btn-confirm").click(function () {
            input_password();
        });

        $('#password').keyup(function (e) {
            if (e.keyCode == 13) { // 엔터 키를 눌렀을 때
                input_password();
            }
        });
        $('#searchInput').keyup(function (e) {
            if (e.keyCode == 13) { // 엔터 키를 눌렀을 때
                if (currentOS != 'web') {
                    window.location.href= "/board/index-mob?" + $('#searchOpt').val() + "=" + $('#searchInput').val();
                } else {
                    window.location.href = "/board/index?" + $('#searchOpt').val() + "=" + $('#searchInput').val();
                }
            }
        });

        $('#btn-search').click(function () {
            if (currentOS != 'web') {
                window.location.href = "/board/index-mob?" + $('#searchOpt').val() + "=" + $('#searchInput').val();
            } else {
                window.location.href = "/board/index?" + $('#searchOpt').val() + "=" + $('#searchInput').val();
            }
        });

    });

    function password_confirm(id,titleType) {
        if(document.getElementById('auth').value=='[ADMIN]' || titleType != null){
            detail_page(id);
        }else{
            $("#id").val(id);
            $("#password").val("");
            $("#pw_layer").show();
        }
    }

    function detail_page(id) {
        window.location.href="/board/user/"+id
    }

    function input_password(){
        var id = $("#id").val();
        var password = $("#password").val(); // 비밀번호 입력란의 값 가져오기

        // POST 요청을 보낼 데이터 객체 생성
        var requestData = JSON.stringify({
            password: password
        });

        $.ajax({
            url: "/board/user/password/" + id,
            type: "POST",
            dataType: "json",
            contentType: 'application/json',
            data: requestData,
            success: function (result) {
                if (result.status == 'SUCCESS') {
                    window.location.href = "/board/user/" + id + "?pw=" + password; // 이동할 페이지 URL로 변경
                    $("#pw_layer").hide();
                } else {
                    alert(result.message);
                    $("#password").val("");
                    $("#password").focus();
                    return;
                }
            },
            error: function (e) {
                console.error(e);
            },
        });
    }

</script>

</body>
</html>